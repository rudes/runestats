image: golang:latest

.docker: &docker
    before_script:
        - wget -q -O /usr/bin/docker https://get.docker.com/builds/Linux/x86_64/docker-1.10.3
        - chmod +x /usr/bin/docker
    services: ["gitlab/dind:dind"]
    variables:
        DOCKER_HOST: tcp://docker:2375

before_script:
        - apt-get update
        - apt-get install -y bc
        - mkdir -p $GOPATH/src/github.com/rudes/runestats
        - cp -r . $GOPATH/src/github.com/rudes/runestats/
        - cd $GOPATH/src/github.com/rudes/runestats/
        - go get -t ./...

test:
    script:
        - go test -v ./...
        - chmod +x .labtest.sh
        - bash ./.labtest.sh

staging:
    <<: *docker
    type: deploy
    script:
        - docker build -t lab.cryocorp.co:5212/rudes/runestats.stream .
        - docker push lab.cryocorp.co:5212/rudes/runestats.stream
    when: on_success
    only:
        - master
